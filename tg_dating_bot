from telethon import TelegramClient, events
import asyncio
from telethon.tl.custom import Button
import datetime
from telethon.tl import functions
import asyncio
import pandas as pd
import os
from telethon import TelegramClient, events, Button
from telethon.errors.rpcerrorlist import MessageNotModifiedError
import numpy as np


api_id = '---'
api_hash = '----'
bot_token = '----'
client = TelegramClient('anon', api_id, api_hash).start(bot_token=bot_token)




user_ratings = {}
usernames = {}
thank_you_msgs = {}
welcome_msgs = {}
users_waiting_for_analysis_end = set()
restart_msgs = {}
start_msgs = {}
sent_msgs = {}
already_asked_to_restart = set()
active_quests = {}
analysis_started = False
user_pair_msgs = {}
should_update_message = True
is_analysis_started = False
analysis_message_ids = {}
user_genders = {}
is_updating_thank_you_message={}
previous_matches = set()
analysis_status = {}


previous_match_msg = {}
image_folder = 'C:/pred/5/10/images/'


from telethon import TelegramClient, events
from telethon.tl.custom import Button
import pandas as pd
import numpy as np
import os
import asyncio
import telethon
from telethon import TelegramClient, events, Button
from telethon.errors.rpcerrorlist import MessageNotModifiedError




import random


@client.on(events.NewMessage(incoming=True))
async def react_and_delete(event):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞
    if not event.message.text.startswith('/'):
        # –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —ç–º–æ–¥–∑–∏
        emoji_list = [
            "‚ù§Ô∏è", "üòä", "üëç", "üòÇ", "üéâ", "üíï", "üòç", "ü§î", "üöÄ", "üëè",
            "üôè", "üéä", "üëÄ", "üòÅ", "üåü", "üíñ", "üåà", "üíØ", "üî•", "üòÉ",
            "üòÑ", "üòÖ", "üòÜ", "üòâ", "üòã", "üòé", "üòú", "üòù", "üòû", "üòü",
            "üò†", "üò¢", "üò£", "üò§", "üò•", "üò¶", "üòß", "üò®", "üò©", "üò™",
            "üò´", "üò¨", "üò≠", "üòÆ", "üòØ", "üò∞", "üò±", "üò≤", "üò≥", "üò¥",
            "üòµ", "üò∂", "üò∏", "üòπ", "üò∫", "üòª", "üòº", "üòΩ", "üòæ", "üòø",
            "üôÄ", "üôÅ", "üôÇ", "üôÉ", "üôÑ", "üôÖ", "üôÜ", "üôá", "üôà", "üôâ",
            "üôä", "üôã", "üôå", "üôç", "üôé", "üôè", "üöÄ", "üöÅ", "üöÇ", "üöÉ",
            "üöÑ", "üöÖ", "üöÜ", "üöá", "üöà", "üöâ", "üöä", "üöã", "üöå", "üöç",
            "üöé", "üöè", "üöê", "üöë", "üöí", "üöì", "üöî", "üöï", "üöñ", "üöó",
            "üöò", "üöô", "üöö", "üöõ", "üöú", "üöù", "üöû", "üöü", "üö†", "üö°",
            "üö¢", "üö£", "üö§", "üö•", "üö¶", "üöß", "üö®", "üö©", "üö™", "üö´",
            "üö¨", "üö≠", "üöÆ", "üöØ", "üö∞", "üö±", "üö≤", "üö≥", "üö¥", "üöµ",
            "üö∂", "üö∑", "üö∏", "üöπ", "üö∫", "üöª", "üöº", "üöΩ", "üöæ", "üöø",
            "üõÄ", "üõÅ", "üõÇ", "üõÉ", "üõÑ", "üõÖ", "üõã", "üõå", "üõç", "üõé",
            "üõè", "üõê", "üõë", "üõí", "üõï", "üõñ", "üõó", "üõò", "üõô", "üõö"
        ]
       
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —ç–º–æ–¥–∑–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
        random_emoji = random.choice(emoji_list)
       
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —ç–º–æ–¥–∑–∏ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
        emoji_msg = await event.respond(random_emoji)
       
        # –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã
        await asyncio.sleep(3)
       
        # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —ç–º–æ–¥–∑–∏
        await client.delete_messages(event.chat_id, [event.message.id, emoji_msg.id])








# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π








async def send_image(user_id, image_num):
    if image_num == 1 and user_id in start_msgs:
        await client.delete_messages(user_id, start_msgs[user_id])


    image_messages = {
        1: "–ü–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Ç—Ä—ë—Ö.",
        2: "–í—Ç–æ—Ä–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Ç—Ä—ë—Ö.",
        3: "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ."
    }


    range_buttons = [
        # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
        [Button.inline("1-8", f"range_{image_num}_1_8"),
        Button.inline("9-16", f"range_{image_num}_9_16"),
        Button.inline("17-24", f"range_{image_num}_17_24"),
        Button.inline("25-33", f"range_{image_num}_25_33")],
        # –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
        [Button.inline("34-41", f"range_{image_num}_34_41"),
        Button.inline("42-49", f"range_{image_num}_42_49"),
        Button.inline("50-58", f"range_{image_num}_50_58"),
        Button.inline("59-66", f"range_{image_num}_59_66")],
        # –¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
        [Button.inline("67-74", f"range_{image_num}_67_74"),
        Button.inline("75-82", f"range_{image_num}_75_82"),
        Button.inline("83-91", f"range_{image_num}_83_91"),
        Button.inline("92-100", f"range_{image_num}_92_100")]
    ]


    sent_msg = await client.send_file(
        user_id, os.path.join(image_folder, f'image{image_num}.jpg'),
        caption=image_messages.get(image_num, ""),
        buttons=range_buttons
    )
    sent_msgs[user_id] = sent_msg.id




@client.on(events.CallbackQuery(pattern='range'))
async def range_handler(event):
    user_id = event.sender_id
    _, image_num, low, high = event.data.decode().split('_')
    image_num, low, high = int(image_num), int(low), int(high)


    half_range = (high - low + 1) // 2
    rating_buttons = [
        [Button.inline(str(i), f'rate_{image_num}_{i}') for i in range(low, low + half_range)],
        [Button.inline(str(i), f'rate_{image_num}_{i}') for i in range(low + half_range, high + 1)]
    ]


    await client.edit_message(
        user_id, event.message_id,
        buttons=rating_buttons
    )








async def update_files():
    # –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –≤—Å–µ —Ç—Ä–∏ –æ—Ü–µ–Ω–∫–∏
    full_ratings = {user_id: ratings for user_id, ratings in user_ratings.items() if len(ratings) == 3}
    if not full_ratings:
        return
   
    # –°–æ–∑–¥–∞–µ–º DataFrame —Å –æ—Ü–µ–Ω–∫–∞–º–∏
    df = pd.DataFrame.from_dict(full_ratings, orient='index', columns=['Image 1', 'Image 2', 'Image 3'])
   
    # –ú–µ–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –Ω–∏–∫–Ω–µ–π–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    df.index = [get_username(user_id) for user_id in df.index]
   
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ñ–∞–π–ª Excel
    df.to_excel('C:/pred/5/10/images/ratings.xlsx')
   
    # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –º—É–∂—á–∏–Ω –∏ –∂–µ–Ω—â–∏–Ω
    men_ids = [user_id for user_id, gender in user_genders.items() if gender == 'male' and user_id in df.index]
    women_ids = [user_id for user_id, gender in user_genders.items() if gender == 'female' and user_id in df.index]


    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º—É–∂—á–∏–Ω–∞ –∏ –æ–¥–Ω–∞ –∂–µ–Ω—â–∏–Ω–∞, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ü–µ–Ω–∏–ª–∏ –≤—Å–µ —Ç—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if not men_ids or not women_ids:
        return
   
    men_ratings = df.loc[men_ids]
    women_ratings = df.loc[women_ids]
   
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫–Ω–µ–π–º—ã –¥–ª—è –º—É–∂—á–∏–Ω –∏ –∂–µ–Ω—â–∏–Ω
    men_usernames = [get_username(user_id) for user_id in men_ids]
    women_usernames = [get_username(user_id) for user_id in women_ids]
   
    # –í—ã—á–∏—Å–ª—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É –æ—Ü–µ–Ω–∫–∞–º–∏ –≤—Å–µ—Ö –º—É–∂—á–∏–Ω –∏ –≤—Å–µ—Ö –∂–µ–Ω—â–∏–Ω –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã
    absolute_differences = np.abs(men_ratings.values[:, None, :] - women_ratings.values[np.newaxis, :, :])
   
    # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö —Ä–∞–∑–Ω–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã
    compatibility_scores = np.mean(absolute_differences, axis=2)
   
    # –°–æ–∑–¥–∞–µ–º DataFrame —Å —Ä–∞–∑–ª–∏—á–∏—è–º–∏, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∏–∫–Ω–µ–π–º—ã
    compatibility_scores_df = pd.DataFrame(compatibility_scores, index=men_usernames, columns=women_usernames)
   
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º DataFrame —Å –æ—Ü–µ–Ω–∫–∞–º–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ —Ñ–∞–π–ª Excel
    compatibility_scores_df.to_excel('C:/pred/5/10/images/compatibility_scores.xlsx')














ALLOW_REPEATS = 0  # –ê–¥–º–∏–Ω—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞: 1 - —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–≤—Ç–æ—Ä—ã, 0 - –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä—ã


def get_username(user_id):
    return usernames.get(user_id, f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}")










async def analysis():
    global should_update_message
    global remaining_analysis_seconds
    should_update_message = True




    for user_id in active_quests.keys():
        if is_updating_thank_you_message.get(user_id, False):
            continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ rate_handler


        message_text = f"–ò–¥–µ—Ç –∞–Ω–∞–ª–∏–∑, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {remaining_analysis_seconds} —Å–µ–∫—É–Ω–¥."
       
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_id in thank_you_msgs:
            try:
                await client.edit_message(user_id, thank_you_msgs[user_id][0], message_text)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–≤–µ—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        elif user_id in welcome_msgs:
            try:
                await client.edit_message(user_id, welcome_msgs[user_id], message_text)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        elif user_id in restart_msgs:
            try:
                await client.edit_message(user_id, restart_msgs[user_id], message_text)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–≤–µ—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")


    # –¶–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    while remaining_analysis_seconds > 0:
        for user_id in active_quests.keys():
            if is_updating_thank_you_message.get(user_id, False):
                continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ rate_handler


            message_text = f"–ò–¥–µ—Ç –∞–Ω–∞–ª–∏–∑, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {remaining_analysis_seconds} —Å–µ–∫—É–Ω–¥."
           
            # –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            if user_id in thank_you_msgs:
                message_id = thank_you_msgs[user_id][0]
            elif user_id in welcome_msgs:
                message_id = welcome_msgs[user_id]
            elif user_id in restart_msgs:
                message_id = restart_msgs[user_id]
            else:
                continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è


            # –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            try:
                await client.edit_message(user_id, message_id, message_text)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")


        await asyncio.sleep(5)  # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        remaining_analysis_seconds -= 5
        if remaining_analysis_seconds <= 0:
            break  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–µ–∫–ª–æ






    active_ratings = {user_id: ratings for user_id, ratings in user_ratings.items() if user_id in active_quests and len(ratings) == 3}
    df = pd.DataFrame.from_dict(active_ratings, orient='index', columns=['Image 1', 'Image 2', 'Image 3'])


    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –∏ –≤ user_genders, –∏ –≤ df
    valid_male_user_ids = [user_id for user_id, gender in user_genders.items() if gender == 'male' and user_id in df.index]
    valid_female_user_ids = [user_id for user_id, gender in user_genders.items() if gender == 'female' and user_id in df.index]


    men_ratings = df.loc[valid_male_user_ids]
    women_ratings = df.loc[valid_female_user_ids]
   
    # –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ —Ç—Ä–µ—Ö–º–µ—Ä–Ω—ã—Ö —Ä–∞–∑–Ω–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã –æ—Ü–µ–Ω–æ–∫
    absolute_differences = np.abs(men_ratings.values[:, None, :] - women_ratings.values[np.newaxis, :, :])
    # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö —Ä–∞–∑–Ω–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã
    compatibility_scores = np.mean(absolute_differences, axis=2)


   
    should_update_message = False
    return df, compatibility_scores, absolute_differences, women_ratings, men_ratings, active_ratings


async def find_best_matches(df, compatibility_scores, absolute_differences, women_ratings, men_ratings, active_ratings):
    print("Starting find_best_matches...")


   
    if len(df) < 2:
        print("Not enough users with full ratings.")
        for user_id in active_quests.keys():
            if len(user_ratings.get(user_id, {})) == 3:
                # –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—à–ª–∏ –∫–≤–µ—Å—Ç, –Ω–æ –Ω–µ –Ω–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                previous_match_msg[user_id] = await client.send_message(int(user_id), "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            else:
                # –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∫–≤–µ—Å—Ç
                await start_new_quest(user_id)
            await ask_for_restart(user_id)
        return
   


   
    notified_users = set()
    users_for_new_quest_invitation = set()
    while len(notified_users) < len(df) and len(notified_users) < len(df) - 1:
        if np.any(np.isfinite(compatibility_scores)):
            print("Searching for best match...")
            min_diff_indices = np.unravel_index(np.argmin(compatibility_scores, axis=None), compatibility_scores.shape)
            closest_users = int(men_ratings.index[min_diff_indices[0]]), int(women_ratings.index[min_diff_indices[1]])
            print(f"Closest users: {closest_users}")


            valid_match = ALLOW_REPEATS or (frozenset(closest_users) not in previous_matches and closest_users[0] not in notified_users and closest_users[1] not in notified_users)
           
            if valid_match:
                print("Valid match found, sending messages...")
               
                # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if closest_users[0] in previous_match_msg:
                    try:
                        await client.delete_messages(closest_users[0], previous_match_msg[closest_users[0]])
                    except telethon.errors.rpcerrorlist.MessageIdInvalidError:
                        pass
                    except telethon.errors.rpcerrorlist.MessageDeleteForbiddenError:
                        pass                        
                    del previous_match_msg[closest_users[0]]
                if closest_users[1] in previous_match_msg:
                    try:
                        await client.delete_messages(closest_users[1], previous_match_msg[closest_users[1]])
                    except telethon.errors.rpcerrorlist.MessageIdInvalidError:
                        pass
                    except telethon.errors.rpcerrorlist.MessageDeleteForbiddenError:
                        pass


                    del previous_match_msg[closest_users[1]]




                min_diff_indices = np.unravel_index(np.argmin(compatibility_scores, axis=None), compatibility_scores.shape)
                closest_users = (int(men_ratings.index[min_diff_indices[0]]), int(women_ratings.index[min_diff_indices[1]]))
                closest_score = compatibility_scores[min_diff_indices]
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Å–ª–æ–≤–∞—Ä—å user_pair_msgs
               
                if remaining_analysis_seconds == 0:
                    new_msg_for_user_0 = await client.send_message(
                        closest_users[0],
                        f"–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –î–ª—è –≤–∞—Å –ø–æ–¥–æ–±—Ä–∞–Ω —Å–∞–º—ã–π —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫: @{get_username(closest_users[1])}. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {closest_score:.2f}"
                    )


                    new_msg_for_user_1 = await client.send_message(
                        closest_users[1],
                        f"–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –î–ª—è –≤–∞—Å –ø–æ–¥–æ–±—Ä–∞–Ω —Å–∞–º—ã–π —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫: @{get_username(closest_users[0])}. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {closest_score:.2f}"
                    )
                # –î–æ–±–∞–≤–ª—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user_pair_msgs.setdefault(closest_users[0], []).append(new_msg_for_user_0.id)
                user_pair_msgs.setdefault(closest_users[1], []).append(new_msg_for_user_1.id)


                # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ–ª–µ–µ 4 —Å–æ–æ–±—â–µ–Ω–∏–π, —É–¥–∞–ª—è–µ–º —Å–∞–º–æ–µ –ø–µ—Ä–≤–æ–µ
                if len(user_pair_msgs[closest_users[0]]) > 3:
                    await client.delete_messages(closest_users[0], user_pair_msgs[closest_users[0]].pop(0))
                if len(user_pair_msgs[closest_users[1]]) > 3:
                    await client.delete_messages(closest_users[1], user_pair_msgs[closest_users[1]].pop(0))


                notified_users.update(closest_users)
                previous_matches.add(frozenset(closest_users))
                await ask_for_restart(closest_users[0])
                await ask_for_restart(closest_users[1])
                if closest_users[0] in thank_you_msgs:
                    await client.delete_messages(closest_users[0], thank_you_msgs[closest_users[0]][0])
                    del thank_you_msgs[closest_users[0]]
                if closest_users[1] in thank_you_msgs:
                    await client.delete_messages(closest_users[1], thank_you_msgs[closest_users[1]][0])


                    del thank_you_msgs[closest_users[1]]
            else:
                print("Match is not valid, continuing search...")
                compatibility_scores[min_diff_indices[0], min_diff_indices[1]] = np.inf
                if closest_users[0] in thank_you_msgs:
                    await client.delete_messages(closest_users[0], thank_you_msgs[closest_users[0]][0])
                   
                    del thank_you_msgs[closest_users[0]]
                if closest_users[1] in thank_you_msgs:
                    await client.delete_messages(closest_users[1], thank_you_msgs[closest_users[1]][0])


                    del thank_you_msgs[closest_users[1]]


        else:
            print("No more possible matches.")
            break
   
    print("No matches found for some users, sending messages...")


    for user_id in active_quests.keys():
        if user_id not in notified_users:
            if len(user_ratings.get(user_id, {})) < 3:
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –∫–≤–µ—Å—Ç
                await start_new_quest(user_id)
            else:
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∏–ª –∫–≤–µ—Å—Ç, –Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω
                if remaining_analysis_seconds == 0:
                    previous_match_msg[user_id] = await client.send_message(user_id, "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –º—ã –Ω–µ —Å–º–æ–≥–ª–∏ –ø–æ–¥–æ–±—Ä–∞—Ç—å –¥–ª—è –≤–∞—Å –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.")
            await ask_for_restart(user_id)
        if user_id in thank_you_msgs:
            await client.delete_messages(user_id, thank_you_msgs[user_id])
            del thank_you_msgs[user_id]
    print("find_best_matches completed.")
    users_for_new_quest_invitation = set(active_quests.keys()) - notified_users
    return users_for_new_quest_invitation


# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é:
async def start_new_quest(user_id):
    global is_analysis_started, should_update_message
   
    is_analysis_started = False
    should_update_message = True
    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if user_id in welcome_msgs:
        try:
            await client.delete_messages(user_id, welcome_msgs[user_id])
        except telethon.errors.rpcerrorlist.MessageIdInvalidError:
            pass
        welcome_msgs.pop(user_id, None)












































               


async def ask_for_restart(user_id):
    if user_id in already_asked_to_restart:
        return
    already_asked_to_restart.add(user_id)
    if user_id in thank_you_msgs:
        try:
            await client.delete_messages(user_id, thank_you_msgs[user_id][0])
        except telethon.errors.rpcerrorlist.MessageIdInvalidError:
            pass
        thank_you_msgs.pop(user_id, None)
    await client.send_message(user_id, "–ù–æ–≤—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–≤–µ—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω.", buttons=[Button.inline("–ù–∞—á–∞—Ç—å –∫–≤–µ—Å—Ç", 'restart')])


async def send_typing_effect(user_id, message):
    sent_msg = await client.send_message(user_id, message)
    return sent_msg.id








@client.on(events.NewMessage(pattern='/start'))
async def start_handler(event):
    user_id = event.sender_id
    user = await event.get_sender()
    if hasattr(user, 'usernames') and user.usernames:
        usernames[user_id] = user.usernames[0].username  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∏–∫–Ω–µ–π–º
    else:
        usernames[user_id] = user.username if user.username else user.id  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ ID
    await event.respond("–í—ã–±–µ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à –ø–æ–ª.", buttons=[Button.inline("–ñ–µ–Ω—Å–∫–∏–π", 'gender_female'), Button.inline("–ú—É–∂—Å–∫–æ–π", 'gender_male')])






@client.on(events.CallbackQuery(pattern='gender'))
async def gender_handler(event):
    user_id = event.sender_id
    _, gender = event.data.decode().split('_')
    user_genders[user_id] = gender
   
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã–±–æ—Ä–µ –ø–æ–ª–∞
    await client.delete_messages(user_id, event.message_id)


    if remaining_seconds > 0 and remaining_analysis_seconds in [ANALYSIS_DURATION, -1]:
        # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        user_ratings[user_id] = {}
        active_quests[user_id] = True
        welcome_msg_id = await send_typing_effect(user_id, "–û—Ü–µ–Ω–∏—Ç–µ —Å–≤–æ—ë –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Å–ª–µ–¥—É—é—â–∏–º —Ç—Ä—ë–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 100...")
        welcome_msgs[user_id] = welcome_msg_id
        await send_image(user_id, 1)
    else:
        # –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∏–¥–µ—Ç –∞–Ω–∞–ª–∏–∑
        sent_message = await client.send_message(user_id, f"–ò–¥–µ—Ç –∞–Ω–∞–ª–∏–∑, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {remaining_analysis_seconds} —Å–µ–∫—É–Ω–¥.")
        users_waiting_for_analysis_end.add(user_id)
        analysis_message_ids[user_id] = sent_message.id




# ... (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥)


@client.on(events.CallbackQuery(pattern='rate'))
async def rate_handler(event):
    global remaining_seconds
    user_id = event.sender_id
    _, image_num, rating = event.data.decode().split('_')
    image_num = int(image_num)
    rating = int(rating)


    if user_id not in user_ratings:
        user_ratings[user_id] = {}
   
    if user_id in user_ratings:
        user_ratings[user_id][f'Image {image_num}'] = rating


    await update_files()


    if user_id in sent_msgs:
        await client.delete_messages(user_id, sent_msgs[user_id])




    next_image_num = image_num + 1
    if next_image_num <= 3:
        await send_image(user_id, next_image_num)
    else:
        if user_id in welcome_msgs:
            await asyncio.sleep(1)
            await client.delete_messages(user_id, welcome_msgs[user_id])
            welcome_msgs.pop(user_id, None)
        if user_id in restart_msgs and next_image_num > 3:
            await client.delete_messages(user_id, restart_msgs[user_id])
            del restart_msgs[user_id]
       
        time_str = time_to_string(remaining_seconds, remaining_analysis_seconds)
        thank_you_msg_text = f"–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ–º –∫–≤–µ—Å—Ç–∞! –ß–µ—Ä–µ–∑ {time_str} –¥–ª—è –≤–∞—Å –±—É–¥–µ—Ç –ø–æ–¥–æ–±—Ä–∞–Ω —Å–∞–º—ã–π —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞."
        thank_you_msg_id = await send_typing_effect(user_id, thank_you_msg_text)
        thank_you_msgs[user_id] = (thank_you_msg_id, thank_you_msg_text)


        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        is_updating_thank_you_message[user_id] = True
        #while remaining_seconds > 0 and should_update_message:
        while remaining_seconds > 0:
            print(f"[Debug] Remaining seconds: {remaining_seconds}, Should update: {should_update_message}")
            await asyncio.sleep(5)  # –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
            new_time_str = time_to_string(remaining_seconds, remaining_analysis_seconds)
            new_msg_text = f"–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ–º –∫–≤–µ—Å—Ç–∞! –ß–µ—Ä–µ–∑ {new_time_str} –¥–ª—è –≤–∞—Å –±—É–¥–µ—Ç –ø–æ–¥–æ–±—Ä–∞–Ω —Å–∞–º—ã–π —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞."
            try:
                if thank_you_msgs.get(user_id):
                    current_msg_text = thank_you_msgs[user_id][1]
                    if current_msg_text != new_msg_text:
                        try:
                            await client.edit_message(user_id, thank_you_msgs[user_id][0], new_msg_text)
                            thank_you_msgs[user_id] = (thank_you_msgs[user_id][0], new_msg_text)
                        except telethon.errors.rpcerrorlist.MessageNotModifiedError:
                            pass
                    else:
                        print(f"Message text did not change for user {user_id}. Current text: '{current_msg_text}', New text: '{new_msg_text}'")
            except telethon.errors.rpcerrorlist.MessageIdInvalidError:
                print(f"Failed to edit message for user {user_id}. Message ID might be invalid.")
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏, –≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ ID –∏–∑ thank_you_msgs
                del thank_you_msgs[user_id]
        is_updating_thank_you_message[user_id] = False










def time_to_string(remaining_seconds, remaining_analysis_seconds):
    total_seconds = remaining_seconds + remaining_analysis_seconds
    hours, remainder = divmod(total_seconds, 3600)
    minutes, seconds = divmod(remainder, 60)
    if hours > 0:
        return f"{hours} —á–∞—Å–æ–≤ {minutes} –º–∏–Ω—É—Ç {seconds} —Å–µ–∫—É–Ω–¥"
    elif minutes > 0:
        return f"{minutes} –º–∏–Ω—É—Ç {seconds} —Å–µ–∫—É–Ω–¥"
    else:
        return f"{seconds} —Å–µ–∫—É–Ω–¥"
   
def num_to_words(num):
    words = ["–æ–¥–∏–Ω", "–¥–≤–∞", "—Ç—Ä–∏", "—á–µ—Ç—ã—Ä–µ", "–ø—è—Ç—å", "—à–µ—Å—Ç—å", "—Å–µ–º—å", "–≤–æ—Å–µ–º—å", "–¥–µ–≤—è—Ç—å", "–¥–µ—Å—è—Ç—å",
             "–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å", "–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å", "—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å", "—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å", "–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å", "—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å",
             "—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å", "–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å", "–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å", "–¥–≤–∞–¥—Ü–∞—Ç—å"]
    if num <= 20:
        return words[num - 1]
    else:
        return f"{words[19]} {words[num - 21]}"




async def delete_unanswered_images():
    for user_id in active_quests.keys():
        if user_id in sent_msgs:
            await client.delete_messages(user_id, sent_msgs[user_id])






@client.on(events.CallbackQuery(pattern='restart'))
async def restart_handler(event):
    user_id = event.sender_id
    user_ratings[user_id] = {}
    active_quests[user_id] = True






    if remaining_seconds == 0:
        # –ï—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –≤—Å–µ –µ—â–µ –∏–¥–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —ç—Ç–æ–º
        sent_message = await client.send_message(user_id, f"–ò–¥–µ—Ç –∞–Ω–∞–ª–∏–∑, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {remaining_analysis_seconds} —Å–µ–∫—É–Ω–¥.")
        users_waiting_for_analysis_end.add(user_id)
        analysis_message_ids[user_id] = sent_message.id
    else:
        # –ï—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –ø—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ –Ω–æ–≤–æ–º—É –∫–≤–µ—Å—Ç—É
        restart_msg = await event.respond("–û—Ü–µ–Ω–∏—Ç–µ —Å–≤–æ—ë –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Å–ª–µ–¥—É—é—â–∏–º —Ç—Ä—ë–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 100. –í–ê–ñ–ù–û: —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ —Ç–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω—é—é –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –Ω–æ –∏ –≤–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–π –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–∏—Ç—É–∞—Ü–∏–∏.")
        restart_msgs[user_id] = restart_msg.id
        await send_image(user_id, 1)








    await client.delete_messages(user_id, event.message_id)
    if user_id in thank_you_msgs:
        await client.delete_messages(user_id, thank_you_msgs[user_id])
        del thank_you_msgs[user_id]
    if user_id in previous_match_msg:  # –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–¥–µ—Å—å
        await client.delete_messages(user_id, previous_match_msg[user_id])  # –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–¥–µ—Å—å
        del previous_match_msg[user_id]  # –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–¥–µ—Å—å
    if user_id in thank_you_msgs:
        await client.delete_messages(user_id, thank_you_msgs[user_id][0])
        del thank_you_msgs[user_id]
    if user_id in welcome_msgs:
        await client.delete_messages(user_id, welcome_msgs[user_id])
        del welcome_msgs[user_id]


   


@client.on(events.NewMessage(pattern='/next'))
async def next_handler(event):
    global remaining_seconds
    remaining_seconds = QUEST_DURATION  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–æ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    await delete_unanswered_images()  # –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π


    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞
    df, compatibility_scores, absolute_differences, women_ratings, men_ratings, active_ratings = await analysis()


    # –í—ã–∑–æ–≤ find_best_matches —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    users_for_new_quest = await find_best_matches(df, compatibility_scores, absolute_differences, women_ratings, men_ratings, active_ratings)


    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è "–ù–∞—á–Ω–µ–º –∫–≤–µ—Å—Ç –∑–∞–Ω–æ–≤–æ!" –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    for user_id in list(active_quests.keys()):
        if user_id in restart_msgs:
            try:
                await client.delete_messages(user_id, restart_msgs[user_id])
            except telethon.errors.rpcerrorlist.MessageIdInvalidError:
                pass
            restart_msgs.pop(user_id, None)
    active_quests.clear()
    already_asked_to_restart.clear()




QUEST_DURATION = 40
remaining_seconds = QUEST_DURATION


ANALYSIS_DURATION = 20 # –î–æ–ø—É—Å—Ç–∏–º, —ç—Ç–æ –±—É–¥–µ—Ç 20 –º–∏–Ω—É—Ç
remaining_analysis_seconds = ANALYSIS_DURATION




async def quest_timer():
    global remaining_seconds, remaining_analysis_seconds, should_update_message
    analysis_done = False  # –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –≤—ã–ø–æ–ª–Ω–µ–Ω –ª–∏ –∞–Ω–∞–ª–∏–∑


    while True:
        await asyncio.sleep(1)  # —Å–ø–∞—Ç—å 1 —Å–µ–∫—É–Ω–¥—É


        if remaining_seconds > 0:
            remaining_seconds -= 1
           
            print(f"–û—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–π–º–µ—Ä: {remaining_seconds} —Å–µ–∫—É–Ω–¥ –æ—Å—Ç–∞–ª–æ—Å—å")
           
        elif remaining_seconds == 0 and not analysis_done:
            should_update_message = True
            print("–û—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑...")
            await delete_unanswered_images()
            df, compatibility_scores, absolute_differences, women_ratings, men_ratings, active_ratings = await analysis()
            remaining_seconds = -1  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–Ω
            analysis_done = True


        if analysis_done and remaining_analysis_seconds > 0:
            print(f"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä –∞–Ω–∞–ª–∏–∑–∞: {remaining_analysis_seconds} —Å–µ–∫—É–Ω–¥ –æ—Å—Ç–∞–ª–æ—Å—å")
            remaining_analysis_seconds -= 1
           
        elif remaining_analysis_seconds == 0:
            print("–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–µ–∫. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–∏—Å–∫ –ª—É—á—à–∏—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π...")
            users_for_new_quest = await find_best_matches(df, compatibility_scores, absolute_differences, women_ratings, men_ratings, active_ratings)
            remaining_analysis_seconds = -1  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–Ω
            analysis_done = False  # –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–≤–µ—Å—Ç–∞
            if users_for_new_quest is not None:
            # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –∫–≤–µ—Å—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞
                for user_id in set(active_quests.keys()).union(users_for_new_quest):
                    await ask_for_restart(user_id)




        if remaining_seconds == -1 and remaining_analysis_seconds == -1:
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è "–ù–∞—á–Ω–µ–º –∫–≤–µ—Å—Ç –∑–∞–Ω–æ–≤–æ!" –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            for user_id in list(active_quests.keys()):
                if user_id in restart_msgs:
                    try:
                        await client.delete_messages(user_id, restart_msgs[user_id])
                    except telethon.errors.rpcerrorlist.MessageIdInvalidError:
                        pass
                    restart_msgs.pop(user_id, None)
            for user_id in is_updating_thank_you_message.keys():
                is_updating_thank_you_message[user_id] = False
            active_quests.clear()
           
            print("–ö–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –¢–∞–π–º–µ—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã.")
            should_update_message = False
            remaining_seconds = QUEST_DURATION  # —Å–±—Ä–æ—Å–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–µ—Å—Ç–∞
            remaining_analysis_seconds = ANALYSIS_DURATION  # —Å–±—Ä–æ—Å–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞
            thank_you_msgs.clear()  
            welcome_msgs.clear()
            for user_id in active_quests.keys():
                is_updating_thank_you_message[user_id] = False




            for user_id in users_waiting_for_analysis_end:
                try:
                    await client.delete_messages(user_id, analysis_message_ids[user_id])


                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
                if user_id not in already_asked_to_restart:
                    await ask_for_restart(user_id)
            users_waiting_for_analysis_end.clear()
            analysis_message_ids.clear()  # –û—á–∏—Å—Ç–∫–∞ —Å–ª–æ–≤–∞—Ä—è ID —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –∞–Ω–∞–ª–∏–∑–µ


            already_asked_to_restart.clear()
   












with client:
    client.loop.create_task(quest_timer())
    client.run_until_disconnected()



